<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="utf-8"/>  
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>  
    <title>  
        English Learning Cards  
    </title>  
    <link rel="manifest" href="manifest.json">  
    <meta name="theme-color" content="#ffffff">  
  
    <link href="style.css" rel="stylesheet"/>  
    <script defer="" src="script.js">  
    </script>  
    <script defer="" src="quiz.js">  
    </script>  
    <script defer="" src="wordhear.js">  
    </script>  
    <script defer="" src="makeword.js">  
    </script>  
    <script defer="" src="utils.js">  
    </script>  
    <script defer="" src="mix.js">  
    </script>  
    <script defer="" src="typegame.js">  
    </script>  
    <script defer="" src="sentence.js">  
    </script>  
    <script defer="" src="puzzle.js">  
    </script>  
    <script src="tts.js"></script>  
    <script>  
        if ('serviceWorker' in navigator) {  
            navigator.serviceWorker.register('service-worker.js')  
                .then(() => console.log("‚úÖ Service Worker ·É†·Éî·Éí·Éò·É°·É¢·É†·Éò·É†·Éî·Éë·É£·Éö·Éò·Éê"))  
                .catch(err => console.error("‚ùå SW error:", err));  
        }  
    </script>  
  
    <!-- ·É®·Éî·Éú·Éò·É®·Éú·Éî, ·É†·Éù·Éõ ·Éù·É†·Éò ·Éê·ÉÆ·Éê·Éö·Éò ·É§·É£·Éú·É•·É™·Éò·Éê ·Éì·Éê·Éí·Éï·É≠·Éò·É†·Éì·Éî·Éë·Éê:  
            getDocs, doc, setDoc, deleteDoc -->  
    <script type="module">  
        import {  
            initializeApp  
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";  
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";  
        import {  
            getFirestore,  
            collection,  
            addDoc,  
            getDocs,  
            doc,  
            setDoc,  
            deleteDoc  
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";  
  
        const firebaseConfig = {  
            apiKey: "AIzaSyArftPeH-SoIwmm2aKLDHBTE8M4DQ5jLM8",  
            authDomain: "worded-1a455.firebaseapp.com",  
            projectId: "worded-1a455",  
            storageBucket: "worded-1a455.appspot.com",  
            messagingSenderId: "385741553786",  
            appId: "1:385741553786:web:c9e1d0d5bb662950f9fbc3",  
            measurementId: "G-9QPQ3JE2MZ"  
        };  
  
        const app = initializeApp(firebaseConfig);  
        const db = getFirestore(app);  
        const messaging = getMessaging(app);  
  
  
        document.getElementById("pullFromFirestoreBtn").addEventListener("click", pullAllCardsFromFirebase);  
  
  
        getToken(messaging, { vapidKey: '385741553786' }).then((currentToken) => {  
            if (currentToken) {  
                console.log("‚úÖ Token:", currentToken);  
            } else {  
                console.warn('‚ùå Token-·Éò·É° ·Éõ·Éò·É¶·Éî·Éë·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê.');  
            }  
        }).catch((err) => {  
            console.error('‚ùå FCM token ·É®·Éî·É™·Éì·Éù·Éõ·Éê:', err);  
        });  
        async function pullAllCardsFromFirebase() {  
            try {  
                const snapshot = await getDocs(collection(db, "cards"));  
                const fetchedCards = [];  
  
                // ·Éö·Éù·Éô·Éê·Éö·É£·É†·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É¨·Éê·Éõ·Éù·É¶·Éî·Éë·Éê  
                const stored = localStorage.getItem("english_cards_app");  
                const localData = stored ? JSON.parse(stored) : { cards: [] };  
  
                const localWordsMap = {};  
                localData.cards.forEach(card => {  
                    localWordsMap[card.word.trim().toLowerCase()] = card;  
                });  
  
                snapshot.forEach(docSnap => {  
                    const cardData = docSnap.data();  
                    const wordKey = cardData.word.trim().toLowerCase();  
                    cardData.firebaseId = docSnap.id;  
  
                    if (localWordsMap[wordKey]) {  
                        // ·É£·Éô·Éï·Éî ·Éê·É†·É°·Éî·Éë·Éù·Éë·É° ‚Üí ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê  
                        (cardData.tags || []).forEach(tag => allTags.add(tag));  
  
                        Object.assign(localWordsMap[wordKey], {  
                            ...cardData,  
                            firebaseId: docSnap.id,  
  
                        });  
                    } else {  
                        (cardData.tags || []).forEach(tag => allTags.add(tag));  
  
                        // ·Éê·ÉÆ·Éê·Éö·Éò ·É°·Éò·É¢·Éß·Éï·Éê  
                        fetchedCards.push(cardData);  
                    }  
                    renderSidebarTags();  
                    populateGlobalTags();  
                    renderTagLibrary();  
  
                });  
  
                const combinedCards = [...localData.cards, ...fetchedCards];  
  
                // ·É®·Éî·Éï·Éò·Éú·Éê·ÉÆ·Éù·Éó  
                localStorage.setItem("english_cards_app", JSON.stringify({ cards: combinedCards }));  
  
                // UI ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê  
                if (window.loadCardsFromStorage) {  
                    document.getElementById('cardContainer').innerHTML = '';  
                    window.loadCardsFromStorage();  
  
                    // ·Éß·Éï·Éî·Éö·Éê ·Éï·Éò·Éñ·É£·Éê·Éö·Éò ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éì·Éî·É° (progress bar ·Éì·Éê mastered)  
                    document.querySelectorAll('.card').forEach(updateCardVisuals);  
  
                }  
  
                alert("‚úî Firestore-·Éì·Éê·Éú ·Éò·Éõ·Éû·Éù·É†·É¢·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éì·Éê·É°·É†·É£·Éö·Éì·Éê!");  
  
            } catch (err) {  
                console.error("‚ùå Firestore Load ·É®·Éî·É™·Éì·Éù·Éõ·Éê:", err);  
                alert("·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê ·É©·Éê·Éõ·Éù·É¢·Éï·Éò·É†·Éó·Éï·Éê Firestore-·Éì·Éê·Éú!");  
            }  
        }  
  
  
  
  
        document.getElementById("syncAllBtn").addEventListener("click", () => {  
            syncAllCardsToFirebase()  
                .then(() => {  
                    alert("·É°·Éò·Éú·É•·É†·Éù·Éú·Éò·Éñ·Éê·É™·Éò·Éê ·Éì·Éê·É°·É†·É£·Éö·Éì·Éê ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó!");  
                })  
                .catch(err => {  
                    console.error("·É°·Éò·Éú·É•·É†·Éù·Éú·Éò·Éñ·Éê·É™·Éò·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê:", err);  
                    alert("·É°·Éò·Éú·É•·É†·Éù·Éú·Éò·Éñ·Éê·É™·Éò·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê!");  
                });  
        });  
  
        async function syncAllCardsToFirebase() {
    const progressLabel = document.getElementById("syncProgress");
    progressLabel.textContent = "0%";

    const stored = localStorage.getItem("english_cards_app");
    if (!stored) throw new Error("·Éö·Éù·Éô·Éê·Éö·É£·É† ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê·É®·Éò ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê");

    const data = JSON.parse(stored);
    const total = data.cards.length;
    let count = 0;

    for (const card of data.cards) {
        const docData = {
            word: card.word,
            mainTranslations: card.mainTranslations,
            extraTranslations: card.extraTranslations,
            tags: card.tags,
            englishSentences: card.englishSentences,
            georgianSentences: card.georgianSentences,
            progress: card.progress || 0,
            updated: Date.now()
        };

        if (!card.firebaseId) {
            const docRef = await addDoc(collection(db, "cards"), docData);
            card.firebaseId = docRef.id;
        } else {
            await setDoc(doc(db, "cards", card.firebaseId), docData, { merge: true });
        }

        count++;
        const percent = ((count / total) * 100).toFixed(1);
        progressLabel.textContent = `${percent}%`;
    }

    // Delete obsolete docs
    const snapshot = await getDocs(collection(db, "cards"));
    const serverIds = new Set();
    snapshot.forEach(docSnap => serverIds.add(docSnap.id));

    const localIds = new Set(data.cards.map(c => c.firebaseId));
    for (const id of serverIds) {
        if (!localIds.has(id)) {
            await deleteDoc(doc(db, "cards", id));
        }
    }

    localStorage.setItem("english_cards_app", JSON.stringify(data));
    progressLabel.textContent = "‚úî";
        }
    </script>  
  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>  
    <!-- Tagify CSS -->  
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet"/>  
    <!-- Font Awesome (latest version) -->  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">  
    </script>  
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify">  
    </script>  
</head>  
<body>  
<div class="top">  
    <div class="top-bar">  
        <div class="top-left">  
            <h1 class="title">  
                English Words  
            </h1>  
        </div>  
        <div class="top-center">  
            <button id="tagLibraryBtn">  
                <i class="fas fa-tags">  
                </i>  
                ·Éó·Éî·Éí·Éî·Éë·Éò  
            </button>  
            <!-- Training Button -->  
            <button id="trainingBtn">  
                <i class="fas fa-tags">  
                </i>  
                ·É¢·É†·Éî·Éú·Éò·Éú·Éí·Éò  
            </button>  
            <div class="input-container search-input">  
                <label class="material-input">  
                    <input class="form-control" id="searchInput" placeholder=" " type="text"/>  
                    <span>  
        ·É´·Éò·Éî·Éë·Éê  
       </span>  
                    <i class="fas fa-search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #aaa;">  
                    </i>  
                </label>  
            </div>  
  
  
        </div>  
        <div class="top-right">  
            <button class="toolbar-btn" id="pullFromFirestoreBtn">Sync</button>  
  
  
            <button class="toolbar-btn" id="syncAllBtn">
  Publish
  <span id="syncProgress" style="margin-left: 8px;"> </span>
</button>  
            <button id="toggleDarkModeBtn" title="Dark Mode Toggle">  
                <i class="fas fa-moon">  
                </i>  
            </button>  
            <button id="settingsBtn">  
                <i class="fas fa-cog">  
                </i>  
            </button>  
        </div>  
    </div>  
    <!-- toolbar ·Éë·Éö·Éù·Éô·Éò -->  
    <div class="card-toolbar" id="cardToolbar">  
        <div class="toolbar-left">  
            <button id="toggleSidebarBtn">  
                <i class="fas fa-tags">  
                </i>  
            </button>  
            <div class="sorting">  
                <i class="fas fa-sort-down" id="sortDirectionIcon">  
                </i>  
                <label class="sort-label" for="sortSelect">  
                </label>  
                <select class="toolbar-select" id="sortSelect">  
                    <option value="alphabetical">  
                        ·Éê·Éú·Éë·Éê·Éú·É£·É†·Éò  
                    </option>  
                    <option value="updated">  
                        ·Éë·Éù·Éö·Éù  
                    </option>  
                    <option selected="" value="progress">  
                        ·Éû·É†·Éù·Éí·É†·Éî·É°·Éò·Éó  
                    </option>  
                </select>  
            </div>  
            <div class="hide-mastered-wrapper">  
                <label style="display: flex; align-items: center; gap: 5px;">  
                    <input id="hideMasteredCheckbox" type="checkbox"/>  
                    <span>  
        - ·Éú·Éê·É°·É¨·Éê·Éï·Éö·Éò  
       </span>  
                </label>  
            </div>  
        </div>  
        <div class="toolbar-center">  
        </div>  
        <div class="toolbar-right">  
            <button id="notificationsBtn" class="toolbar-btn"><i class="fa-regular fa-bell"></i></button>  
  
  
            <button class="toolbar-btn" id="statsBtn" title="·É°·É¢·Éê·É¢·Éò·É°·É¢·Éò·Éô·Éê">  
                <i class="fas fa-chart-pie">  
                </i>  
                ·É°·É¢·Éê·É¢·Éò·É°·É¢·Éò·Éô·Éê  
            </button>  
        </div>  
    </div>  
</div>  
<div class="card-container" id="cardContainer">  
    <!-- ·Éì·Éò·Éú·Éê·Éõ·Éò·É£·É†·Éò ·É•·Éê·É†·Éì·Éî·Éë·Éò ·É©·Éú·Éì·Éî·Éë·Éê ·Éê·É• -->  
</div>  
<!-- ·Éõ·Éù·Éì·Éê·Éö·Éò -->  
<div class="modal-overlay" id="modalOverlay">  
    <div class="modal">  
        <div class="modal-actions close-modal">  
            <button class="close-button" id="closeAddModalBtn">  
                √ó  
            </button>  
        </div>  
        <h2>  
            ·Éê·ÉÆ·Éê·Éö·Éò ·É°·Éò·É¢·Éß·Éï·Éê  
        </h2>  
        <div class="input-container">  
            <label class="material-input validation">  
                <input class="form-control" id="wordInput" placeholder=" " required="" type="text" value="(·Éï·Éê·Éö·Éò·Éì·Éê·É™·Éò·Éê)"/>  
                <span>  
       ·É°·Éê·É¨·Éß·Éò·É°·Éò ·É°·Éò·É¢·Éß·Éï·Éê  
      </span>  
            </label>  
        </div>  
        <div class="input-container tag-input">  
            <label class="material-input">  
                <input id="mainTranslationInput" placeholder=" " type="text"/>  
                <span>  
       ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·Éó·Éê·É†·Éí·Éõ·Éê·Éú·Éò  
      </span>  
            </label>  
            <button id="addMainTranslationBtn">  
                +  
            </button>  
        </div>  
        <div class="tags-display" id="mainTranslationTags">  
        </div>  
        <div class="input-container tag-input">  
            <label class="material-input">  
                <input id="extraTranslationInput" placeholder=" " type="text"/>  
                <span>  
       ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éî·Éë·Éò ·Éó·Éê·É†·Éí·Éõ·Éê·Éú·Éò  
      </span>  
            </label>  
            <button id="addExtraTranslationBtn">  
                +  
            </button>  
        </div>  
        <div class="tags-display" id="extraTranslationTags">  
        </div>  
        <div class="input-container tag-input">  
            <label class="material-input">  
                <input id="tagInput" placeholder=" " type="text"/>  
                <span>  
       ·É©·Éê·É¨·Éî·É†·Éî ·Éê·Éú ·Éê·Éê·É†·É©·Éò·Éî ·Éó·Éî·Éí·Éò  
      </span>  
            </label>  
            <button id="addTagBtn">  
                +  
            </button>  
            <div class="dropdown" id="tagDropdown">  
            </div>  
        </div>  
        <div class="tags-display" id="tagList">  
        </div>  
        <div class="input-container">  
            <label class="material-input">  
                <textarea class="form-control" id="englishSentences" placeholder=" " rows="6"></textarea>  
                <span>  
       ·Éò·Éú·Éí·Éö·Éò·É°·É£·É†·Éò ·É¨·Éò·Éú·Éê·Éì·Éê·Éî·Éë·Éî·Éë·Éò  
      </span>  
            </label>  
        </div>  
        <div class="input-container">  
            <label class="material-input">  
                <textarea class="form-control" id="georgianSentences" placeholder=" " rows="5"></textarea>  
                <span>  
       ·É•·Éê·É†·Éó·É£·Éö·Éò ·É¨·Éò·Éú·Éê·Éì·Éê·Éî·Éë·Éî·Éë·Éò  
      </span>  
            </label>  
        </div>  
        <div class="modal-actions">  
            <button id="saveCardBtn">  
                ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê  
            </button>  
            <button id="cancelBtn">  
                ·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê  
            </button>  
        </div>  
    </div>  
</div>  
<div class="modal-overlay" id="tagLibraryModal" style="display:none;">  
    <div class="modal tag-library-modal">  
        <div class="modal-actions close-modal" id="closeTagLibraryBtn">  
            <button class="close-button" id="closeTagLibraryXBtn">  
                √ó  
            </button>  
        </div>  
        <h2>  
            ·Éó·Éî·Éí·Éî·Éë·Éò·É° ·Éë·Éò·Éë·Éö·Éò·Éù·Éó·Éî·Éô·Éê  
        </h2>  
        <!-- ‚úÖ ·Éû·Éò·É†·Éï·Éî·Éö·Éê·Éì ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê -->  
        <div class="tag-library-footer">  
            <div class="input-container">  
                <label class="material-input">  
                    <input class="form-control" id="newTagInput" placeholder=" " type="text">  
                    <span>  
         ·Éê·ÉÆ·Éê·Éö·Éò ·Éó·Éî·Éí·Éò  
        </span>  
                    </input>  
                </label>  
            </div>  
            <button id="addNewTagBtn">  
                <i class="fas fa-plus">  
                </i>  
                ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê  
            </button>  
        </div>  
        <ul class="tag-list-container" id="tagListContainer">  
        </ul>  
    </div>  
</div>  
<button class="mobile-sidebar-btn" id="mobileSidebarBtn">  
    <i class="fas fa-filter">  
    </i>  
</button>  
<div class="sidebar" id="sidebar">  
    <div class="tags-header">  
        <button id="closeSidebarBtn" style="float:right;">  
            ‚úñ  
        </button>  
        <h3>  
            ·Éó·Éî·Éí·Éî·Éë·Éò  
        </h3>  
        <button class="clear-tags-btn" id="clearTagFiltersBtn">  
            ‚úñ ·É§·Éò·Éö·É¢·É†·Éò·É° ·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê  
        </button>  
    </div>  
    <ul id="sidebarTagList">  
    </ul>  
</div>  
<div class="modal-overlay" id="cardPreviewModal" style="display: none;">  
    <!-- ·Éí·Éê·Éì·Éê·É¢·Éê·Éú·Éò·Éö·Éò ·É¶·Éò·Éö·Éê·Éô·Éî·Éë·Éò ·Éõ·Éù·Éì·Éê·Éö·Éò·É° ·É®·Éò·Éí·Éú·Éò·Éó -->  
    <button class="nav-btn inside-nav left-nav fas fa-angle-left" id="prevCardBtn">  
    </button>  
    <button class="nav-btn inside-nav right-nav fas fa-angle-right" id="nextCardBtn">  
    </button>  
    <div class="modal preview-modal">  
        <div class="modal-actions close-modal">  
            <button class="close-button" id="closePreviewBtn">  
                √ó  
            </button>  
        </div>  
        <div class="preview-sticky">  
            <h2 id="previewWord">  
            </h2>  
            <hr/>  
            <p id="previewTranslation">  
            </p>  
            <div class="tags" id="previewTags">  
            </div>  
        </div>  
        <div class="modal-section sentence-preview">  
            <h3>  
                ·Éò·Éú·Éí·Éö·Éò·É°·É£·É†·Éò  
            </h3>  
            <div class="sentence-list" id="previewEnglishSentences">  
            </div>  
            <h3>  
                ·É•·Éê·É†·Éó·É£·Éö·Éò  
            </h3>  
            <div class="sentence-list" id="previewGeorgianSentences">  
            </div>  
        </div>  
    </div>  
</div>  
<div class="modal-overlay" id="settingsModal" style="display: none; gap: 10px; flex-wrap: wrap;">  
    <div class="modal" style="max-width: 500px;">  
        <div class="modal-actions close-modal">  
            <button class="close-button" id="closeSettingsBtn">  
                √ó  
            </button>  
        </div>  
        <h2>  
            ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò  
        </h2>  
        <!-- üîà Voice ·Éê·É†·É©·Éî·Éï·Éê -->  
        <div class="input-container">  
            <label class="material-input material-select">  
                <select id="voiceSelect" required="">  
                    <option disabled="" hidden="" selected="" value="">  
                    </option>  
                    <option value="Libby">  
                        Microsoft Libby Online  
                    </option>  
                    <option value="Maisie">  
                        Microsoft Maisie Online  
                    </option>  
                    <option value="Ryan">  
                        Microsoft Ryan Online  
                    </option>  
                    <option value="Sonia">  
              
