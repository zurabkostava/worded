<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="utf-8"/>  
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>  
    <title>  
        English Learning Cards  
    </title>  
    <link rel="manifest" href="manifest.json">  
    <meta name="theme-color" content="#ffffff">  
  
    <link href="style.css" rel="stylesheet"/>  
    <script defer="" src="script.js">  
    </script>  
    <script defer="" src="quiz.js">  
    </script>  
    <script defer="" src="wordhear.js">  
    </script>  
    <script defer="" src="makeword.js">  
    </script>  
    <script defer="" src="utils.js">  
    </script>  
    <script defer="" src="mix.js">  
    </script>  
    <script defer="" src="typegame.js">  
    </script>  
    <script defer="" src="sentence.js">  
    </script>  
    <script defer="" src="puzzle.js">  
    </script>  
    <script src="tts.js"></script>  
    <script>  
        if ('serviceWorker' in navigator) {  
            navigator.serviceWorker.register('service-worker.js')  
                .then(() => console.log("âœ… Service Worker áƒ áƒ”áƒ’áƒ˜áƒ¡áƒ¢áƒ áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ"))  
                .catch(err => console.error("âŒ SW error:", err));  
        }  
    </script>  
  
    <!-- áƒ¨áƒ”áƒœáƒ˜áƒ¨áƒœáƒ”, áƒ áƒáƒ› áƒáƒ áƒ˜ áƒáƒ®áƒáƒšáƒ˜ áƒ¤áƒ£áƒœáƒ¥áƒªáƒ˜áƒ áƒ“áƒáƒ’áƒ•áƒ­áƒ˜áƒ áƒ“áƒ”áƒ‘áƒ:  
            getDocs, doc, setDoc, deleteDoc -->  
    <script type="module">  
        import {  
            initializeApp  
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";  
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";  
        import {  
            getFirestore,  
            collection,  
            addDoc,  
            getDocs,  
            doc,  
            setDoc,  
            deleteDoc  
        } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";  
  
        const firebaseConfig = {  
            apiKey: "AIzaSyArftPeH-SoIwmm2aKLDHBTE8M4DQ5jLM8",  
            authDomain: "worded-1a455.firebaseapp.com",  
            projectId: "worded-1a455",  
            storageBucket: "worded-1a455.appspot.com",  
            messagingSenderId: "385741553786",  
            appId: "1:385741553786:web:c9e1d0d5bb662950f9fbc3",  
            measurementId: "G-9QPQ3JE2MZ"  
        };  
  
        const app = initializeApp(firebaseConfig);  
        const db = getFirestore(app);  
        const messaging = getMessaging(app);  
  
  
        document.getElementById("pullFromFirestoreBtn").addEventListener("click", pullAllCardsFromFirebase);  
  
  
        getToken(messaging, { vapidKey: '385741553786' }).then((currentToken) => {  
            if (currentToken) {  
                console.log("âœ… Token:", currentToken);  
            } else {  
                console.warn('âŒ Token-áƒ˜áƒ¡ áƒ›áƒ˜áƒ¦áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ.');  
            }  
        }).catch((err) => {  
            console.error('âŒ FCM token áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:', err);  
        });  
        async function pullAllCardsFromFirebase() {  
            try {  
                const snapshot = await getDocs(collection(db, "cards"));  
                const fetchedCards = [];  
  
                // áƒšáƒáƒ™áƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ¬áƒáƒ›áƒáƒ¦áƒ”áƒ‘áƒ  
                const stored = localStorage.getItem("english_cards_app");  
                const localData = stored ? JSON.parse(stored) : { cards: [] };  
  
                const localWordsMap = {};  
                localData.cards.forEach(card => {  
                    localWordsMap[card.word.trim().toLowerCase()] = card;  
                });  
  
                snapshot.forEach(docSnap => {  
                    const cardData = docSnap.data();  
                    const wordKey = cardData.word.trim().toLowerCase();  
                    cardData.firebaseId = docSnap.id;  
  
                    if (localWordsMap[wordKey]) {  
                        // áƒ£áƒ™áƒ•áƒ” áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡ â†’ áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ  
                        (cardData.tags || []).forEach(tag => allTags.add(tag));  
  
                        Object.assign(localWordsMap[wordKey], {  
                            ...cardData,  
                            firebaseId: docSnap.id,  
  
                        });  
                    } else {  
                        (cardData.tags || []).forEach(tag => allTags.add(tag));  
  
                        // áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ  
                        fetchedCards.push(cardData);  
                    }  
                    renderSidebarTags();  
                    populateGlobalTags();  
                    renderTagLibrary();  
  
                });  
  
                const combinedCards = [...localData.cards, ...fetchedCards];  
  
                // áƒ¨áƒ”áƒ•áƒ˜áƒœáƒáƒ®áƒáƒ—  
                localStorage.setItem("english_cards_app", JSON.stringify({ cards: combinedCards }));  
  
                // UI áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ  
                if (window.loadCardsFromStorage) {  
                    document.getElementById('cardContainer').innerHTML = '';  
                    window.loadCardsFromStorage();  
  
                    // áƒ§áƒ•áƒ”áƒšáƒ áƒ•áƒ˜áƒ–áƒ£áƒáƒšáƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ”áƒ¡ (progress bar áƒ“áƒ mastered)  
                    document.querySelectorAll('.card').forEach(updateCardVisuals);  
  
                }  
  
                alert("âœ” Firestore-áƒ“áƒáƒœ áƒ˜áƒ›áƒáƒáƒ áƒ¢áƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ!");  
  
            } catch (err) {  
                console.error("âŒ Firestore Load áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:", err);  
                alert("áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ áƒ©áƒáƒ›áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ Firestore-áƒ“áƒáƒœ!");  
            }  
        }  
  
  
  
  
        document.getElementById("syncAllBtn").addEventListener("click", () => {  
            syncAllCardsToFirebase()  
                .then(() => {  
                    alert("áƒ¡áƒ˜áƒœáƒ¥áƒ áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ“áƒ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—!");  
                })  
                .catch(err => {  
                    console.error("áƒ¡áƒ˜áƒœáƒ¥áƒ áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ˜áƒ¡ áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ:", err);  
                    alert("áƒ¡áƒ˜áƒœáƒ¥áƒ áƒáƒœáƒ˜áƒ–áƒáƒªáƒ˜áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ!");  
                });  
        });  
  
        async function syncAllCardsToFirebase() {
    const progressLabel = document.getElementById("syncProgressLabel");
    const stored = localStorage.getItem("english_cards_app");
    if (!stored) throw new Error("áƒšáƒáƒ™áƒáƒšáƒ£áƒ  áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒáƒ¨áƒ˜ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ");

    const data = JSON.parse(stored);
    const totalCards = data.cards.length || 1; // áƒáƒ  áƒ“áƒáƒ•áƒ£áƒ¨áƒ•áƒáƒ— division by zero
    let uploaded = 0;

    for (const card of data.cards) {
        const docData = {
            word: card.word,
            mainTranslations: card.mainTranslations,
            extraTranslations: card.extraTranslations,
            tags: card.tags,
            englishSentences: card.englishSentences,
            georgianSentences: card.georgianSentences,
            progress: card.progress || 0,
            updated: Date.now()
        };

        if (!card.firebaseId) {
            const docRef = await addDoc(collection(db, "cards"), docData);
            card.firebaseId = docRef.id;
        } else {
            await setDoc(doc(db, "cards", card.firebaseId), docData, { merge: true });
        }

        uploaded++;
        const percent = ((uploaded / totalCards) * 100).toFixed(1);
        progressLabel.textContent = `â€” ${percent}%`;
    }

    // áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡ áƒšáƒáƒ’áƒ˜áƒ™áƒ áƒ“áƒáƒ áƒ©áƒ”áƒ¡ áƒ£áƒªáƒ•áƒšáƒ”áƒšáƒ˜...

    // áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ
    localStorage.setItem("english_cards_app", JSON.stringify(data));
    progressLabel.textContent = ""; // áƒ“áƒáƒ¡áƒ áƒ£áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ
}
    </script>  
  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>  
    <!-- Tagify CSS -->  
    <link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet"/>  
    <!-- Font Awesome (latest version) -->  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">  
    </script>  
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify">  
    </script>  
</head>  
<body>  
<div class="top">  
    <div class="top-bar">  
        <div class="top-left">  
            <h1 class="title">  
                English Words  
            </h1>  
        </div>  
        <div class="top-center">  
            <button id="tagLibraryBtn">  
                <i class="fas fa-tags">  
                </i>  
                áƒ—áƒ”áƒ’áƒ”áƒ‘áƒ˜  
            </button>  
            <!-- Training Button -->  
            <button id="trainingBtn">  
                <i class="fas fa-tags">  
                </i>  
                áƒ¢áƒ áƒ”áƒœáƒ˜áƒœáƒ’áƒ˜  
            </button>  
            <div class="input-container search-input">  
                <label class="material-input">  
                    <input class="form-control" id="searchInput" placeholder=" " type="text"/>  
                    <span>  
        áƒ«áƒ˜áƒ”áƒ‘áƒ  
       </span>  
                    <i class="fas fa-search" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #aaa;">  
                    </i>  
                </label>  
            </div>  
  
  
        </div>  
        <div class="top-right">  
            <button class="toolbar-btn" id="pullFromFirestoreBtn">Sync</button>  
  
  
            <button class="toolbar-btn" id="syncAllBtn">
  Publish
  <span id="syncProgress" style="margin-left: 8px;"> </span>
</button>  
            <button id="toggleDarkModeBtn" title="Dark Mode Toggle">  
                <i class="fas fa-moon">  
                </i>  
            </button>  
            <button id="settingsBtn">  
                <i class="fas fa-cog">  
                </i>  
            </button>  
        </div>  
    </div>  
    <!-- toolbar áƒ‘áƒšáƒáƒ™áƒ˜ -->  
    <div class="card-toolbar" id="cardToolbar">  
        <div class="toolbar-left">  
            <button id="toggleSidebarBtn">  
                <i class="fas fa-tags">  
                </i>  
            </button>  
            <div class="sorting">  
                <i class="fas fa-sort-down" id="sortDirectionIcon">  
                </i>  
                <label class="sort-label" for="sortSelect">  
                </label>  
                <select class="toolbar-select" id="sortSelect">  
                    <option value="alphabetical">  
                        áƒáƒœáƒ‘áƒáƒœáƒ£áƒ áƒ˜  
                    </option>  
                    <option value="updated">  
                        áƒ‘áƒáƒšáƒ  
                    </option>  
                    <option selected="" value="progress">  
                        áƒáƒ áƒáƒ’áƒ áƒ”áƒ¡áƒ˜áƒ—  
                    </option>  
                </select>  
            </div>  
            <div class="hide-mastered-wrapper">  
                <label style="display: flex; align-items: center; gap: 5px;">  
                    <input id="hideMasteredCheckbox" type="checkbox"/>  
                    <span>  
        - áƒœáƒáƒ¡áƒ¬áƒáƒ•áƒšáƒ˜  
       </span>  
                </label>  
            </div>  
        </div>  
        <div class="toolbar-center">  
        </div>  
        <div class="toolbar-right">  
            <button id="notificationsBtn" class="toolbar-btn"><i class="fa-regular fa-bell"></i></button>  
  
  
            <button class="toolbar-btn" id="statsBtn" title="áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ">  
                <i class="fas fa-chart-pie">  
                </i>  
                áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ  
            </button>  
        </div>  
    </div>  
</div>  
<div class="card-container" id="cardContainer">  
    <!-- áƒ“áƒ˜áƒœáƒáƒ›áƒ˜áƒ£áƒ áƒ˜ áƒ¥áƒáƒ áƒ“áƒ”áƒ‘áƒ˜ áƒ©áƒœáƒ“áƒ”áƒ‘áƒ áƒáƒ¥ -->  
</div>  
<!-- áƒ›áƒáƒ“áƒáƒšáƒ˜ -->  
<div class="modal-overlay" id="modalOverlay">  
    <div class="modal">  
        <div class="modal-actions close-modal">  
            <button class="close-button" id="closeAddModalBtn">  
                Ã—  
            </button>  
        </div>  
        <h2>  
            áƒáƒ®áƒáƒšáƒ˜ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ  
        </h2>  
        <div class="input-container">  
            <label class="material-input validation">  
                <input class="form-control" id="wordInput" placeholder=" " required="" type="text" value="(áƒ•áƒáƒšáƒ˜áƒ“áƒáƒªáƒ˜áƒ)"/>  
                <span>  
       áƒ¡áƒáƒ¬áƒ§áƒ˜áƒ¡áƒ˜ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ  
      </span>  
            </label>  
        </div>  
        <div class="input-container tag-input">  
            <label class="material-input">  
                <input id="mainTranslationInput" placeholder=" " type="text"/>  
                <span>  
       áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒ—áƒáƒ áƒ’áƒ›áƒáƒœáƒ˜  
      </span>  
            </label>  
            <button id="addMainTranslationBtn">  
                +  
            </button>  
        </div>  
        <div class="tags-display" id="mainTranslationTags">  
        </div>  
        <div class="input-container tag-input">  
            <label class="material-input">  
                <input id="extraTranslationInput" placeholder=" " type="text"/>  
                <span>  
       áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ—áƒ”áƒ‘áƒ˜ áƒ—áƒáƒ áƒ’áƒ›áƒáƒœáƒ˜  
      </span>  
            </label>  
            <button id="addExtraTranslationBtn">  
                +  
            </button>  
        </div>  
        <div class="tags-display" id="extraTranslationTags">  
        </div>  
        <div class="input-container tag-input">  
            <label class="material-input">  
                <input id="tagInput" placeholder=" " type="text"/>  
                <span>  
       áƒ©áƒáƒ¬áƒ”áƒ áƒ” áƒáƒœ áƒáƒáƒ áƒ©áƒ˜áƒ” áƒ—áƒ”áƒ’áƒ˜  
      </span>  
            </label>  
            <button id="addTagBtn">  
                +  
            </button>  
            <div class="dropdown" id="tagDropdown">  
            </div>  
        </div>  
        <div class="tags-display" id="tagList">  
        </div>  
        <div class="input-container">  
            <label class="material-input">  
                <textarea class="form-control" id="englishSentences" placeholder=" " rows="6"></textarea>  
                <span>  
       áƒ˜áƒœáƒ’áƒšáƒ˜áƒ¡áƒ£áƒ áƒ˜ áƒ¬áƒ˜áƒœáƒáƒ“áƒáƒ”áƒ‘áƒ”áƒ‘áƒ˜  
      </span>  
            </label>  
        </div>  
        <div class="input-container">  
            <label class="material-input">  
                <textarea class="form-control" id="georgianSentences" placeholder=" " rows="5"></textarea>  
                <span>  
       áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒ¬áƒ˜áƒœáƒáƒ“áƒáƒ”áƒ‘áƒ”áƒ‘áƒ˜  
      </span>  
            </label>  
        </div>  
        <div class="modal-actions">  
            <button id="saveCardBtn">  
                áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ  
            </button>  
            <button id="cancelBtn">  
                áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ  
            </button>  
        </div>  
    </div>  
</div>  
<div class="modal-overlay" id="tagLibraryModal" style="display:none;">  
    <div class="modal tag-library-modal">  
        <div class="modal-actions close-modal" id="closeTagLibraryBtn">  
            <button class="close-button" id="closeTagLibraryXBtn">  
                Ã—  
            </button>  
        </div>  
        <h2>  
            áƒ—áƒ”áƒ’áƒ”áƒ‘áƒ˜áƒ¡ áƒ‘áƒ˜áƒ‘áƒšáƒ˜áƒáƒ—áƒ”áƒ™áƒ  
        </h2>  
        <!-- âœ… áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒáƒ“ áƒ’áƒáƒ›áƒáƒ©áƒœáƒ“áƒ”áƒ‘áƒ -->  
        <div class="tag-library-footer">  
            <div class="input-container">  
                <label class="material-input">  
                    <input class="form-control" id="newTagInput" placeholder=" " type="text">  
                    <span>  
         áƒáƒ®áƒáƒšáƒ˜ áƒ—áƒ”áƒ’áƒ˜  
        </span>  
                    </input>  
                </label>  
            </div>  
            <button id="addNewTagBtn">  
                <i class="fas fa-plus">  
                </i>  
                áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ  
            </button>  
        </div>  
        <ul class="tag-list-container" id="tagListContainer">  
        </ul>  
    </div>  
</div>  
<button class="mobile-sidebar-btn" id="mobileSidebarBtn">  
    <i class="fas fa-filter">  
    </i>  
</button>  
<div class="sidebar" id="sidebar">  
    <div class="tags-header">  
        <button id="closeSidebarBtn" style="float:right;">  
            âœ–  
        </button>  
        <h3>  
            áƒ—áƒ”áƒ’áƒ”áƒ‘áƒ˜  
        </h3>  
        <button class="clear-tags-btn" id="clearTagFiltersBtn">  
            âœ– áƒ¤áƒ˜áƒšáƒ¢áƒ áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ  
        </button>  
    </div>  
    <ul id="sidebarTagList">  
    </ul>  
</div>  
<div class="modal-overlay" id="cardPreviewModal" style="display: none;">  
    <!-- áƒ’áƒáƒ“áƒáƒ¢áƒáƒœáƒ˜áƒšáƒ˜ áƒ¦áƒ˜áƒšáƒáƒ™áƒ”áƒ‘áƒ˜ áƒ›áƒáƒ“áƒáƒšáƒ˜áƒ¡ áƒ¨áƒ˜áƒ’áƒœáƒ˜áƒ— -->  
    <button class="nav-btn inside-nav left-nav fas fa-angle-left" id="prevCardBtn">  
    </button>  
    <button class="nav-btn inside-nav right-nav fas fa-angle-right" id="nextCardBtn">  
    </button>  
    <div class="modal preview-modal">  
        <div class="modal-actions close-modal">  
            <button class="close-button" id="closePreviewBtn">  
                Ã—  
            </button>  
        </div>  
        <div class="preview-sticky">  
            <h2 id="previewWord">  
            </h2>  
            <hr/>  
            <p id="previewTranslation">  
            </p>  
            <div class="tags" id="previewTags">  
            </div>  
        </div>  
        <div class="modal-section sentence-preview">  
            <h3>  
                áƒ˜áƒœáƒ’áƒšáƒ˜áƒ¡áƒ£áƒ áƒ˜  
            </h3>  
            <div class="sentence-list" id="previewEnglishSentences">  
            </div>  
            <h3>  
                áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜  
            </h3>  
            <div class="sentence-list" id="previewGeorgianSentences">  
            </div>  
        </div>  
    </div>  
</div>  
<div class="modal-overlay" id="settingsModal" style="display: none; gap: 10px; flex-wrap: wrap;">  
    <div class="modal" style="max-width: 500px;">  
        <div class="modal-actions close-modal">  
            <button class="close-button" id="closeSettingsBtn">  
                Ã—  
            </button>  
        </div>  
        <h2>  
            áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜  
        </h2>  
        <!-- ğŸ”ˆ Voice áƒáƒ áƒ©áƒ”áƒ•áƒ -->  
        <div class="input-container">  
            <label class="material-input material-select">  
                <select id="voiceSelect" required="">  
                    <option disabled="" hidden="" selected="" value="">  
                    </option>  
                    <option value="Libby">  
                        Microsoft Libby Online  
                    </option>  
                    <option value="Maisie">  
                        Microsoft Maisie Online  
                    </option>  
                    <option value="Ryan">  
                        Microsoft Ryan Online  
                    </option>  
                    <option value="Sonia">  
              
